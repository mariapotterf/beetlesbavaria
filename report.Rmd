---
title: "Ips population dynamic in Bavaria (2015-2021)"
author: "MÃ¡ria Potterf"
date:  "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    toc: true
    toc_depth: 3
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "../outReports",
      output_file = file.path("../outReports", glue::glue('Beetles_dyn_{Sys.Date()}'
    )))
  })

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy = TRUE, tidy.opts = list(comment = FALSE), message = F, warning = F)
knitr::opts_chunk$set(fig.width=6, fig.height=3) 

```


```{css, echo=FALSE}
p.caption {
  font-size: 0.8em;
}
```


```{r setup-root}

knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file('C:/Users/ge45lep/Documents/2022_BarkBeetles_Bavaria/beetlesbavaria'))

```


```{r, check-dir, include=FALSE}
#knitr::opts_knit$set(root.dir = "C:/Users/ge45lep/Documents/2021_Franconia_mortality/r_franconia_mortality")

#getwd()
```


```{r, read-data, include = F}

load(file = "outData/ips.Rdata")
load(file = "outData/spatial.Rdata")
load(file = "outData/predict.Rdata")
load(file = "outData/lisa.Rdata")


library(dplyr)
library(ggpubr)

```

# Research questions

Q1: Variation of beetle population dynamics over time and space: 

 - How do beetle counts change over time and space?
   - Sum beetle counts per trap/year
 - Does beetle population increase earlier in the year? When does the main increase in population (*swarming*) happen?
   - Identify day of the year (DOY) of the maximal difference in beetle counts between two consecutive dates.
 - Do beetles aggregate faster? When they reach the same threshold? (1000 beetles) *aggregation*
   - Identify (DOY) of reaching the 1000 beetles per trap.
   
Q2: Regional vs global variation?

- are the traps near by more similar than the traps further away?
- LISA - local indicators of spatial assotiationa
- Global Moran's I
- variograms

Q3: Drivers? (data collected, but not analyzed yet)

- temperature
- precipitation
- SPEI (drought) index - lower value, more drought
- soil water content (swvl) - ration volume water/volume soil: higher the number, more water, less drought
- elevation
- spruce%
- spruce vs. deciduous%


# Methods

## Input data

### Beetle trap dataset overview

- trap datasets in trap pairs, covering area of Bavaria over 2015-2021
- consistent monitoring: 79*2 traps per whole research period
- traps emptied over whole year, roughtly in two weeks interval (range 7 - 30 days)
- individual trap name = 'falsto_name' - one trap can have several globalid, if moved over years. Keep only one globalid per trap. Only one 'globalid' for Ips and Pityogenes traps locations.


To test if the importance of drivers explaining variability changed over time: 
perform temporal interaction analysis - 
allows to assess whether the relationships between the drivers 
and the response variable differ across different time periods. 





## Dependent variables

- total sum of beetles per trap/year.
- beetle emergence: the max difference in beetle counts between consecutive dates 
- beetle aggregation : DOY of the beetles reaching 1000 beetles/trap.






```{r summary-tab, caption = 'sum table'}

summary(ips2)

```


```{r}
ggarrange(p_temp, p_prec)
```

## Data processing

### Curate the data 

- vegetation period: April 1st to Oct 30 (DOY start `r doy.start` - DOY end `r doy.end`)
- removed:

  + if revisit times is less then 5 per season
  + zero beetles cough per whole season 
  + trap number 3 (not a pair: 1 or 2)
  + only kept consistent traps, they were surveyed per whole period 2015-2021 -> 79*2 traps in total (158)



### Identify multicollinearity

VIF - variance inflation factor
values for each predictor variable in the model to determine if multicollinearity

<1 - relatively independent
1-5 - very little dependent
>5 - likely concerning
### Predictors maps

SPEI

# Results 

DOY overview

   DOY    Date

 - 100 - April 10
 - 150 - May 30
 - 200 - July 19
 - 211 - July 30
 - 250 - Sept 7


## Descriptive stats

```{r p_hist_daily_counts, fig.width = 3, fig.height = 2.5, echo = F, fig.cap="Histogram of average daily traps"}
hist(df.daily$avg_day_count)
```


## Beetle dynamics spatio-temporal variation

### Beetle counts, emergence and aggregation DOY

```{r p_bars, fig.width = 6, fig.height = 6, echo = F, fig.cap="Beetle population dynamics. (a) total sum per year. (b) DOY of beetle aggregation per trap. (c) DOY of max increase between dates, (d) Max increase in beetle numbers. Shown are medians and IQR. "}

ggarrange(p_ips.year.sum, 
          p_ips.agg,
          p_ips.max.diff.doy, 
          p_ips.max.diff, labels = 'auto',
          ncol = 2, nrow = 2 )

```


### Temporal variation of beetles counts within a year

RQ: Does the increase in population happens earlier in year?

Calculate the differences in beetle counts between two consecutive dates. Find the max increase per trap & year. Identify the DOY when this max increase happend.


```{r p_count_diff, fig.width = 5, fig.height = 5, echo = F, fig.cap="Average differences in consecutive beetle counts per year (DOY - day of the year) over the study period (2015:2021)"}

#p_count_diff  

```

#### Map: Timing of the beetle swarming  

Max increase in beetle population per DOY (all)

```{r map_p_doy_max_increase, fig.width = 6, fig.height = 6, echo = F, fig.cap="DOY of max increase of betle counts between two consecutive days and size of beetles numbers increase"}

p_doy_max_increase  

```

#### Map: Map: Timing of the beetle swarming (filtered, <150)

Max increase in beetle population per DOY (filtered, <150)
```{r map_p_doy_max_increase160, fig.width = 6, fig.height = 6, echo = F, fig.cap="DOY of max increase of betle counts between two consecutive days and size of beetles numbers increase: filtered for DOY < 150 (May 30)"}

p_doy_max_increase150  

```




#### Summary table: Max increase in beetle population per DOY & max difference
```{r}
max.diff.doy %>% 
  as.data.frame() %>% 
  group_by(year) %>% 
  dplyr::summarise(min    = min(doy),
            max    = max(doy),
            mean   = mean(doy),
            sd     = sd(doy),
            #cv     = sd/mean,
            median = median(doy)) %>% 
  round() %>% 
  knitr::kable("markdown", caption = 'DOY of the max increase in beetle numbers.')


# Check Max increase population
max.diff.doy %>% 
  as.data.frame() %>% 
  group_by(year) %>% 
  dplyr::summarise(min = min(diff),
            max = max(diff),
            mean = mean(diff),
            sd = sd(diff),
           # cv = sd/mean,
            median = median(diff)
            )  %>% 
  knitr::kable("markdown", caption = 'Max increase of beetle numbers ')

```




#### Map: Beetle aggregation per DOY (DOY < 130)

```{r map_p_aggreg, fig.width = 6, fig.height = 6, echo = F, fig.cap="DOY (<130) of aggregated beetles per trap"}

p_aggreg  

```



```{r}
ips.aggreg %>% 
  as.data.frame() %>% 
  group_by(year) %>% 
  dplyr::summarise(min    = min(doy),
                   max    = max(doy),
                   mean   = mean(doy),
                   sd     = sd(doy),
                  # cv     = sd/mean,
                   median = median(doy))  %>% 
  knitr::kable("markdown", caption = 'DOY of Beetle aggregation (1000)') 
  
```





## Local vs regional variation

### LISA: measure of similarity between trap and its surrounding

10 nearest distance neighbors
LISA idetifies the (di)similarity in beetles counst between neighbouring locations. 

Categories: 

- High-High - hotspot, having relatively high value, cluster
- High-Low - dissimilar values from neighours
- Low-High - dissimilar values from neighours 
- Low-Low - coldspots, similar to neighbors

Individual years were sliced, so he yearly hotspots vs coldspots are classified within the respective year.


```{r p_lisa_sub, fig.width = 6, fig.height = 6, echo = F, fig.cap="Local Indicators of Spatial Assotiation. Shown are only High-High and Low-Low clusters. No significat values are not shown."}

p_lisa_sub  

```

What is the share of the similar vs dissimilar beetle counts over years?

```{r p_lisa_freq, fig.width = 3, fig.height = 2.5, echo = F, fig.cap="Local Indicators of Spatial Assotiation. Frequency of the similarity categories: High-High, High-Low, Low-High, Low-Low"}

p_lisa_freq +
  theme_bw()

```

### Global Moran's I - overall measure of spatial autocorrelation over Bavaria

```{r p_glob_moran_bar, fig.width = 2.5, fig.height = 2.5, echo = F, fig.cap="Global Moran's I per each year. Higher value indicates higher autocorrelation"}

p_glob_moran_bar  

```

### Semivariance
```{r semi_out, fig.width = 6, fig.height = 6, echo = F, fig.cap="Variograms per year. Note the different variogram fitting (line)"}

semi_out  

```
    


